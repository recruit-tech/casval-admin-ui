<template>
  <div>
    <hr>
    <div class="d-flex flex-row my-4">
      <div class="pr-1"><input type="text" class="form-control form-control-sm" v-model="keyword" :placeholder="$t('vulnerability.search')" @blur="loadVulnerabilities(1)" @keyup.enter="loadVulnerabilities(1)"></div>
      <div class="ml-auto">
        <select class="form-control form-control-sm" v-model="fixRequired" @change="loadVulnerabilities(1)">
          <option value="">{{ $t('vulnerability.fix-required') }}</option>
          <option value="true">{{ $t('vulnerability.fix-required-true') }}</option>
          <option value="false">{{ $t('vulnerability.fix-required-false') }}</option>
          <option value="unknown">{{ $t('vulnerability.fix-required-unknown') }}</option>
        </select>
      </div>
    </div>
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th scope="col">{{ $t('vulnerability.id') }}</th>
          <th scope="col">{{ $t('vulnerability.title') }}</th>
          <th scope="col">{{ $t('vulnerability.fix-required') }}</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(vuln, index) in vulnerabilities" :key="index">
          <td>{{displayOid(vuln.oid)}}</td>
          <td>{{vuln.name}}</td>
          <td>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" :name="`radio-${index}`" @change="updateFixRequired(vuln.oid, true)" :checked="vuln.fix_required === true">
              <label class="form-check-label" :for="`radio-${index}`">{{ $t('vulnerability.fix-required-true') }}</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" :name="`radio-${index}`" @change="updateFixRequired(vuln.oid, false)" :checked="vuln.fix_required === false">
              <label class="form-check-label" :for="`radio-${index}`">{{ $t('vulnerability.fix-required-false') }}</label>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <hr class="mt-0">
    <div class="d-flex flex-row justify-content-end my-0">
      <div class="pr-1"><button type="button" class="btn btn-sm btn-outline-secondary float-right mr-2" :disabled="currentPage==1" @click="loadVulnerabilities(currentPage - 1)">{{ $t('vulnerability.previous') }}</button></div>
      <div><button type="button" class="btn btn-sm btn-outline-secondary float-right" :disabled="loadedCount < displayCount" @click="loadVulnerabilities(currentPage + 1)">{{ $t('vulnerability.next') }}</button></div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'VulnerabilityList',
  props: {
    vulnerabilityApiClient: {
      type: Function,
      required: true,
    },
  },
  data() {
    return {
      fixRequired: '',
      keyword: '',
      vulnerabilities: [],
      errorMessage: '',
      currentPage: 1,
      displayCount: 10,
      loadedCount: 0,
    };
  },
  methods: {
    displayOid: function displayOid(oid) {
      return oid.replace(process.env.VUE_APP_OPENVAS_OID_PREFIX, '');
    },
    updateFixRequired: async function updateFixRequired(id, fixRequired) {
      try {
        const res = await this.vulnerabilityApiClient.patch(id, { fix_required: fixRequired });
        switch (res.status) {
          case 200: {
            break;
          }
          default: {
            this.errorMessage = this.$i18n.t('vulnerability.error-update');
          }
        }
      } catch (e) {
        this.errorMessage = this.$i18n.t('vulnerability.error-update');
      }
    },
    loadVulnerabilities: async function loadVulnerabilities(page) {
      try {
        const res = await this.vulnerabilityApiClient.get(`?fix_required=${this.fixRequired}&keyword=${this.keyword}&page=${page}&count=${this.displayCount}`);
        switch (res.status) {
          case 200:
          case 304:
            this.loadedCount = res.data.length;
            this.vulnerabilities = res.data;
            this.currentPage = page;
            break;
          default:
            this.errorMessage = this.$i18n.t('vulnerability.error-loading');
        }
      } catch (e) {
        this.errorMessage = this.$i18n.t('vulnerability.error-loading');
      }
    },
  },
  mounted: function mounted() {
    this.loadVulnerabilities(this.currentPage);
  },
};
</script>
