<template>
  <div>
    <hr>
    <div class="d-flex flex-row my-4">
      <div class="pr-1"><input type="text" class="form-control form-control-sm" v-model="oid" placeholder="OID" @blur="search"></div>
      <div class="ml-auto">
        <select class="form-control form-control-sm" :disabled="mode!=='all'" v-model="fixRequired" @change="loadVulnerabilities('')">
          <option value="">Fix Required...</option>
          <option value="true">要</option>
          <option value="false">不要</option>
          <option value="unknown">未設定</option>
        </select>
      </div>
    </div>
    <table class="table table-hover mb-0">
      <thead>
        <tr>
          <th scope="col">OID</th>
          <th scope="col">タイトル</th>
          <th scope="col">修正要否</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(vuln, index) in vulnerabilities" :key="index">
          <td>{{displayOid(vuln.oid)}}</td>
          <td>{{vuln.name}}</td>
          <td>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" :name="`radio-${index}`" @change="changeFixRequired(vuln.oid, true)" :checked="vuln.fix_required === true">
              <label class="form-check-label" :for="`radio-${index}`">要</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="radio" :name="`radio-${index}`" @change="changeFixRequired(vuln.oid, false)" :checked="vuln.fix_required === false">
              <label class="form-check-label" :for="`radio-${index}`">不要</label>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    <hr class="mt-0">
    <div class="d-flex flex-row justify-content-end my-0">
      <div class="pr-1"><button type="button" class="btn btn-sm btn-outline-secondary float-right mr-2" :disabled="mode!=='all'" @click="loadVulnerabilities('previous')">Previous</button></div>
      <div><button type="button" class="btn btn-sm btn-outline-secondary float-right" :disabled="mode!=='all'" @click="loadVulnerabilities('next')">Next</button></div>
    </div>
  </div>
</template>

<script>
export default {
  name: 'VulnerabilityList',
  props: {
    vulnerabilityApiClient: {
      type: Function,
      required: true,
    },
  },
  data() {
    return {
      vulnerabilities: [],
      minOid: null,
      maxOid: null,
      mode: 'all',
      oid: '',
      fixRequired: '',
    };
  },
  methods: {
    search: async function search() {
      let searchOid = this.oid;
      if (this.oid.length === 0) {
        this.mode = 'all';
        return;
      }
      if (this.oid.startsWith(process.env.VUE_APP_OPENVAS_OID_PREFIX) === false) {
        if (!(Number(this.oid) > 0)) {
          return;
        }
        searchOid = process.env.VUE_APP_OPENVAS_OID_PREFIX + this.oid;
      }
      try {
        this.searching = true;
        const res = await this.vulnerabilityApiClient.get(searchOid);
        switch (res.status) {
          case 200:
          case 304:
            this.mode = 'search';
            this.vulnerabilities = [res.data];
            this.minOid = null;
            this.maxOid = null;
            break;
          default: {
            this.vulnerabilities = [];
          }
        }
      } catch (e) {
        this.vulnerabilities = [];
      }
      this.searching = false;
    },
    displayOid: function displayOid(oid) {
      return oid.replace(process.env.VUE_APP_OPENVAS_OID_PREFIX, '');
    },
    changeFixRequired: async function changeFixRequired(oid, fixRequired) {
      try {
        const res = await this.vulnerabilityApiClient.patch(oid, { fix_required: fixRequired });
        switch (res.status) {
          case 200: {
            break;
          }
          default: {
            this.vulnerabilities = [];
          }
        }
      } catch (e) {
        this.vulnerabilities = [];
      }
    },
    loadVulnerabilities: async function loadVulnerabilities(dir) {
      let range = '';
      if (dir === 'previous') {
        range = `&before=${this.minOid}`;
      } else if (dir === 'next') {
        range = `&after=${this.maxOid}`;
      }
      try {
        const res = await this.vulnerabilityApiClient.get(`?fix_required=${this.fixRequired}${range}`);
        switch (res.status) {
          case 200:
          case 304:
            if (res.data.length > 0) {
              this.vulnerabilities = res.data;
              this.minOid = res.data[0].oid;
              this.maxOid = res.data[res.data.length - 1].oid;
            }
            break;
          default:
            this.vulnerabilities = [];
        }
      } catch (e) {
        this.vulnerabilities = [];
      }
    },
  },
  mounted: function mounted() {
    this.loadVulnerabilities(0);
  },
};
</script>
